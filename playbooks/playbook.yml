---
- name: MacOS X Provisioning
  hosts: workstation
  gather_facts: False
  hosts: 127.0.0.1
  connection: local
  vars:
    zsh_path: /bin/zsh
    current_shell: "{{ lookup('env','SHELL') }}"
  tasks:
    - name: install homebrew
      command: ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)" creates=/usr/local/bin/brew

    - name: add homebrew taps
      homebrew_tap: tap={{ item }} state=present
      with_items:
        - osso/formula
        - caskroom/cask
        - homebrew/completions

    - name: install apps from homebrew
      homebrew: name={{ item }} state=present
      with_items:
        # Gnu utils like ls
        - coreutils
        # Invenio
        - autoconf
        - automake
        # Version control
        - git
        - mercurial
        # More up to date and avoids poluting the system packages dir
        - python
        # Golang
        - go
        # Database
        - mariadb
        # File synching
        - syncthing
        # Http client
        - wget
        - httpie
        # For watching network traffic
        - ngrep
        # For installing the mac os x apps
        - brew-cask
        - rename
        # Shell completions
        - vagrant-completion
        - django-completion
        - pip-completion
        - zsh-completions
        - bash-completion
        # Required by zsh
        - gdbm
        # Required by shell prompt
        - vcprompt

    - name: install cask apps from homebrew
      homebrew_cask: name={{ item }} state=present
      with_items:
        - alfred
        - dropbox
        # - java not compatible with Yosemite yet
        - skype
        - vagrant
        - virtualbox
        - cleanmymac
        - colloquy
        - fitbit-connect
        - grandperspective
        - mplayerx
        - istat-menus

    #  # Needs to be installed after XQuartz
    # - name: install apps from homebrew
    #   homebrew: name=poppler state=present

    - name: Allow homebrew zsh to be selected as default shell
      sudo: true
      lineinfile: dest=/etc/shells line={{ zsh_path }}

    - name: Set default shell to zsh
      command: chsh -s {{ zsh_path }}
      when: "current_shell != zsh_path"

    - name: Create bash conf directory
      file: dest=~/.bash state=directory

    - name: Create zsh conf directory
      file: dest=~/.zsh state=directory

    - name: Create zsh autocomplete plugins directory
      file: dest=~/.zsh/autocomplete state=directory

    - name: Create ipython conf directory (1/2)
      file: dest=~/.ipython state=directory

    - name: Create ipython conf directory (2/2)
      file: dest=~/.ipython/profile_default state=directory

    - name: create homedir symlinks
      file: src="~/Sync/Provisioning/{{ item.from }}" dest="{{ item.to }}" state=link
      sudo: no
      with_items:
        # Bash
        - from: shells/bash/profile
          to: ~/.bash_profile
        - from: shells/bash/bashrc
          to: ~/.bashrc
        # Zsh
        - from: shells/zsh/profile
          to: ~/.zprofile
        - from: shells/zsh/zshrc
          to: ~/.zshrc
        - from: shells/zsh/completion
          to: ~/.zsh/completion

        # Shell colors
        - from: shells/colors
          to: ~/.bash/colors
        - from: shells/colors
          to: ~/.zsh/colors

        # Dir colors
        - from: shells/dircolors
          to: ~/.dircolors

        # Shell prompt
        - from: shells/bash/prompt
          to: ~/.bash/prompt
        - from: shells/zsh/prompt
          to: ~/.zsh/prompt

        # Alias
        - from: shells/alias
          to: ~/.bash/alias
        - from: shells/alias
          to: ~/.zsh/alias

        # Shell env
        - from: shells/env
          to: ~/.bash/env
        - from: shells/env
          to: ~/.zsh/env

        # Shell funcs
        - from: shells/func
          to: ~/.bash/func
        - from: shells/func
          to: ~/.zsh/func

        # Git
        - from: git/gitconfig
          to: ~/.gitconfig
        - from: git/gitignore
          to: ~/.gitignore

        # Mercurial
        - from: hg/hgrc
          to: ~/.hgrc
        - from: hg/hgignore
          to: ~/.hgignore

        # Zsh bookmarks
        - from: shells/zsh/zshmarks/zshmarks.plugin.zsh
          to: ~/.zsh/zshmarks
        - from: shells/zsh/zshmarks/_jump
          to: ~/.zsh/autocomplete/_jump
        - from: shells/zsh/bookmarks
          to: ~/.bookmarks

        # Misc
        - from: inputrc
          to: ~/.inputrc
        - from: wgetrc
          to: ~/.wgetrc
        - from: vimrc
          to: ~/.vimrc
        - from: pylintrc
          to: ~/.pylintrc
        - from: nanorc
          to: ~/.nanorc

        # IPython
        - from: python/invenio.ipython.py
          to: ~/.ipython/invenio.ipython.py
        - from: python/ipython_config.py
          to: ~/.ipython/profile_default/ipython_config.py

        # Path Directories
        - from: bin
          to: ~/bin
        - from: lib
          to: ~/lib

        # Sublime
        - from: sublime/Default (OSX).sublime-keymap
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/Default (OSX).sublime-keymap"
        - from: sublime/Preferences.sublime-settings
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/Preferences.sublime-settings"
        - from: sublime/RunMultipleCommands.py
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/RunMultipleCommands.py"
        - from: sublime/Twilight.tmTheme
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/Twilight.tmTheme"
        - from: sublime/Package Control.sublime-settings
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/Package Control.sublime-settings"
        - from: sublime/DetectSyntax.sublime-settings
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/DetectSyntax.sublime-settings"
        - from: sublime/Snippets.py
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/Snippets.py"
        - from: sublime/PythonSnippets.sublime-commands
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/PythonSnippets.sublime-commands"
        - from: sublime/SublimePython.sublime-settings
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/SublimePython.sublime-settings"
        - from: sublime/SublimeLinter.sublime-settings
          to: "/Users/osso/Library/Application Support/Sublime Text 3/Packages/User/SublimeLinter.sublime-settings"

    - name: easy install pip
      easy_install: name=pip
      sudo: yes

    - name: install apps from pip
      pip: name={{ item }}
      with_items:
        # Virtual environments
        - virtualenv
        - virtualenvwrapper
        - pew
        # CLI awk like python
        - pythonpy
        # Requires by some scripts in ~/bin
        - plumbum
        # Linters for sublime text
        - pep8
        - pylint
        # Always useful
        - ipython

    - name: install powerline for vim
      command: pip install git+git://github.com/Lokaltog/powerline creates=/usr/local/bin/powerline
