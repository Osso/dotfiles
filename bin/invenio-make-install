#!/usr/local/bin/python

import os
import sys

from plumbum import local
from plumbum.cmd import make, inveniocfg

CFG_INVENIO_SRCDIR = os.environ.get('CFG_INVENIO_SRCDIR', "~/src/invenio")
CFG_INVENIO_PREFIX = os.environ.get('CFG_INVENIO_PREFIX', "/opt/invenio")


def die(msg):
    print >>sys.stderr, msg
    sys.exit(1)

def silence(cmd):
    return cmd > "/dev/null"


def main():
    if not CFG_INVENIO_PREFIX:
        die("CFG_INVENIO_PREFIX is empty")

    print("Installing invenio")
    with local.cwd(CFG_INVENIO_SRCDIR):
        silence(make['-s'])()
        silence(make['-s', 'install'])()

    print("Recreating configuration file")
    silence(inveniocfg['--update-all'])()

    print("Done")


if __name__ == '__main__':
    main()
