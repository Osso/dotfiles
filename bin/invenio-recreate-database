#!/usr/local/bin/python

import os
import sys

from plumbum import local
from plumbum.cmd import make, mkdir, rm, cp, inveniocfg

CFG_INVENIO_SRCDIR = os.environ.get('CFG_INVENIO_SRCDIR', "~/src/invenio")
CFG_INSPIRE_SRCDIR = os.environ.get('CFG_INSPIRE_SRCDIR', "~/src/inspire")
CFG_INVENIO_PREFIX = os.environ.get('CFG_INVENIO_PREFIX', "/opt/invenio")


def die(msg):
    print >>sys.stderr, msg
    sys.exit(1)


def silence(cmd):
    return cmd > "/dev/null"


def main():
    if not CFG_INVENIO_PREFIX:
        die("CFG_INVENIO_PREFIX is empty")

    print("Deleting invenio")
    with local.cwd(CFG_INVENIO_PREFIX):
        rm['-rf', "lib/invenio"]()
        rm['-rf', "var"]()
        rm['-rf', "etc"]()
    print("Installing invenio")
    with local.cwd(CFG_INVENIO_SRCDIR):
        silence(make['-s'])()
        silence(make['-s', 'install'])()
        with local.cwd('po'):
            silence(make['install-data-yes'])
    print("Recreating configuration file")
    cp["%s/../invenio-local.conf" % CFG_INVENIO_SRCDIR, "%s/etc/" % CFG_INVENIO_PREFIX]()
    silence(inveniocfg['--update-all'])()
    print("Dropping tables")
    inveniocfg['--drop-tables', '--yes-i-know']()
    print("Creating tables")
    inveniocfg['--create-tables', '--yes-i-know']()
    print("Loading atlantis demo site")
    silence(inveniocfg['--create-demo-site',
                       '--load-demo-records',
                       '--yes-i-know'])()
    # print("Creating openoffice tmp directory")
    # with local.cwd(CFG_INVENIO_PREFIX):
    #     mkdir['-p', 'var/tmp/ooffice-tmp-files']()
    print("Done")


if __name__ == '__main__':
    main()
